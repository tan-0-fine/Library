package Server;

import java.io.*;
import java.net.*;

public class ClientHandler implements Runnable {
    private Socket socket;
    private BufferedReader in;
    private PrintWriter out;
    private LibraryData library;   // d√πng chung LibraryData t·ª´ server

    // ‚úÖ Constructor nh·∫≠n th√™m LibraryData
    public ClientHandler(Socket socket, LibraryData libraryData) {
        this.socket = socket;
        this.library = libraryData;
    }

    @Override
    public void run() {
        try {
            in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));
            out = new PrintWriter(socket.getOutputStream(), true);

            out.println("üìö Ket noi toi Library Server thanh cong!");
            out.println("Nhap lenh: SEARCH <keyword>, BORROW <id>, RETURN <id>, EXIT");

            String msg;
            while ((msg = in.readLine()) != null) {
                System.out.println("üì© Nhan tu client: " + msg);

                if (msg.equalsIgnoreCase("EXIT")) {
                    out.println("Tam biet!");
                    break;
                }

                String[] parts = msg.split(" ", 2);
                String command = parts[0].toUpperCase();
                String response;

                switch (command) {
                    case "SEARCH":
                        if (parts.length > 1) response = library.search(parts[1]);
                        else response = "‚ö†Ô∏è Cu phap: SEARCH <tu khoa>";
                        break;

                    case "BORROW":
                        if (parts.length > 1) response = library.borrow(parts[1]);
                        else response = "‚ö†Ô∏è Cu phap: BORROW <id>";
                        break;

                    case "RETURN":
                        if (parts.length > 1) response = library.returnBook(parts[1]);
                        else response = "‚ö†Ô∏è Cu phap: RETURN <id>";
                        break;

                    default:
                        response = "‚ùì Lenh khong hop le.";
                }

                out.println(response);
            }

        } catch (IOException e) {
            System.out.println("‚ùå Client ngat ket noi: " + socket.getInetAddress());
        } finally {
            try { socket.close(); } catch (IOException e) {}
        }
    }
}

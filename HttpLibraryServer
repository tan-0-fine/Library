package Server;

import java.io.*;
import java.net.*;

public class HttpLibraryServer {
    private static LibraryData library = new LibraryData("data/books.txt");

    public static void main(String[] args) throws IOException {
        int port = 8080;
        ServerSocket serverSocket = new ServerSocket(port);
        System.out.println("üåê HTTP Library Server ch·∫°y t·∫°i http://localhost:" + port);

        while (true) {
            Socket client = serverSocket.accept();
            new Thread(() -> handleClient(client)).start();
        }
    }

    private static void handleClient(Socket client) {
        try (
            BufferedReader in = new BufferedReader(new InputStreamReader(client.getInputStream()));
            PrintWriter out = new PrintWriter(client.getOutputStream());
        ) {
            // ƒê·ªçc request HTTP (ch·ªâ d√≤ng ƒë·∫ßu ti√™n GET ...)
            String line = in.readLine();
            if (line == null) return;
            System.out.println("üì© HTTP Request: " + line);

            String response;
            if (line.startsWith("GET /search")) {
                String keyword = getQueryParam(line, "keyword");
                response = library.search(keyword);
            } else if (line.startsWith("GET /borrow")) {
                String id = getQueryParam(line, "id");
                response = library.borrow(id);
            } else if (line.startsWith("GET /return")) {
                String id = getQueryParam(line, "id");
                response = library.returnBook(id);
            } else {
                response = "‚ö†Ô∏è D√πng /search?keyword=... ho·∫∑c /borrow?id=... ho·∫∑c /return?id=...";
            }

            // Tr·∫£ v·ªÅ HTTP Response
            out.println("HTTP/1.1 200 OK");
            out.println("Content-Type: text/html; charset=UTF-8");
            out.println();
            out.println("<html><body>");
            out.println("<h2>üìö K·∫øt qu·∫£:</h2>");
            out.println("<pre>" + response + "</pre>");
            out.println("</body></html>");
            out.flush();

        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            try { client.close(); } catch (IOException e) {}
        }
    }

    private static String getQueryParam(String requestLine, String key) {
        // V√≠ d·ª•: GET /search?keyword=Java HTTP/1.1
        int qIndex = requestLine.indexOf("?");
        if (qIndex == -1) return "";
        String[] params = requestLine.substring(qIndex + 1, requestLine.indexOf(" ", qIndex)).split("&");
        for (String p : params) {
            String[] kv = p.split("=");
            if (kv.length == 2 && kv[0].equals(key)) return kv[1];
        }
        return "";
    }
}
